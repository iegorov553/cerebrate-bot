"""
Command handlers for the Hour Watcher Bot.

This module contains all user command handlers (non-admin).
"""

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, ContextTypes

from bot.config import Config
from bot.database.client import DatabaseClient
from bot.cache.ttl_cache import TTLCache
from bot.utils.rate_limiter import MultiTierRateLimiter, rate_limit
from bot.database.user_operations import UserOperations
from bot.keyboards.keyboard_generators import create_main_menu, create_settings_menu, create_friends_menu

from monitoring import get_logger, set_user_context, track_errors_async

logger = get_logger(__name__)


@rate_limit("general")
@track_errors_async("start_command")
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle /start command - register user and show main menu."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    # Get dependencies from context
    db_client: DatabaseClient = context.bot_data['db_client']
    config: Config = context.bot_data['config']
    
    # Get user cache
    user_cache: TTLCache = context.bot_data['user_cache']
    
    # Ensure user exists in database
    user_ops = UserOperations(db_client, user_cache)
    try:
        user_data = await user_ops.ensure_user_exists(
            tg_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name
        )
    except Exception as e:
        logger.error(f"Failed to ensure user exists: {e}")
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        return

    # Create main menu
    keyboard = create_main_menu(config.is_admin_configured() and user.id == config.admin_user_id)
    
    welcome_text = f"üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n\n" \
                   f"ü§ñ **Hour Watcher Bot** –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–≤–æ—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.\n\n" \
                   f"–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:"

    await update.message.reply_text(
        welcome_text,
        reply_markup=keyboard,
        parse_mode='Markdown'
    )
    
    logger.info(f"User {user.id} opened main menu")


@rate_limit("settings")
@track_errors_async("settings_command")
async def settings_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show user settings from database."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    # Get dependencies
    db_client: DatabaseClient = context.bot_data['db_client']
    user_cache: TTLCache = context.bot_data['user_cache']
    
    # Get user settings from database
    user_ops = UserOperations(db_client, user_cache)
    user_data = await user_ops.get_user_settings(user.id)
    
    if not user_data:
        await update.message.reply_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start"
        )
        return
    
    # Create settings menu
    keyboard = create_settings_menu()
    
    settings_text = f"‚öôÔ∏è **–¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**\n\n" \
                   f"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {'‚úÖ –í–∫–ª—é—á–µ–Ω—ã' if user_data['enabled'] else '‚ùå –û—Ç–∫–ª—é—á–µ–Ω—ã'}\n" \
                   f"‚è∞ –í—Ä–µ–º—è: {user_data['window_start']} - {user_data['window_end']}\n" \
                   f"üìä –ß–∞—Å—Ç–æ—Ç–∞: –∫–∞–∂–¥—ã–µ {user_data['interval_min']} –º–∏–Ω—É—Ç"

    await update.message.reply_text(
        settings_text,
        reply_markup=keyboard,
        parse_mode='Markdown'
    )


@rate_limit("general")
@track_errors_async("history_command")
async def history_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Open web interface for activity history."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    config: Config = context.bot_data['config']
    
    # Create web app button
    web_app = WebAppInfo(url=f"{config.webapp_url}/history")
    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("üìä –û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é", web_app=web_app)
    ]])
    
    await update.message.reply_text(
        "üìä **–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**\n\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ç–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:",
        reply_markup=keyboard,
        parse_mode='Markdown'
    )


@rate_limit("friend_request")
@track_errors_async("add_friend_command")
async def add_friend_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle /add_friend command."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    if not context.args:
        await update.message.reply_text(
            "üë• **–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞**\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `/add_friend @username`\n\n"
            "–ü—Ä–∏–º–µ—Ä: `/add_friend @john_doe`",
            parse_mode='Markdown'
        )
        return
    
    # Extract and validate username
    target_username_raw = context.args[0]
    
    from bot.utils.datetime_utils import validate_username
    is_valid, error_msg = validate_username(target_username_raw)
    if not is_valid:
        await update.message.reply_text(
            f"‚ùå {error_msg}\n\n"
            "–ü—Ä–∏–º–µ—Ä: `/add_friend @username`",
            parse_mode='Markdown'
        )
        return
    
    target_username = target_username_raw.lstrip('@')
    
    # Get dependencies
    db_client: DatabaseClient = context.bot_data['db_client']
    user_cache: TTLCache = context.bot_data['user_cache']
    
    # Implement friend request logic
    from bot.database.friend_operations import FriendOperations
    friend_ops = FriendOperations(db_client)
    user_ops = UserOperations(db_client, user_cache)
    
    # Find target user by username
    target_user = await user_ops.find_user_by_username(target_username)
    if not target_user:
        await update.message.reply_text(
            f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{target_username} –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n"
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–æ—Ç–µ."
        )
        return
    
    target_id = target_user['tg_id']
    
    # Send friend request (will check for existing friendship internally)
    success = await friend_ops.create_friend_request(user.id, target_id)
    if success:
        await update.message.reply_text(
            f"üì§ –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @{target_username}!\n\n"
            "–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
        )
        
        # Notify target user if possible
        try:
            await context.bot.send_message(
                chat_id=target_id,
                text=f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{user.username or user.first_name} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è!\n\n"
                     f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /friend_requests –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞–º–∏."
            )
        except Exception as e:
            logger.warning(f"Could not notify user {target_id}: {e}")
            
    else:
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


@rate_limit("general")
@track_errors_async("friends_command")
async def friends_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show friends menu."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    # Create friends menu
    keyboard = create_friends_menu()
    
    await update.message.reply_text(
        "üë• **–î—Ä—É–∑—å—è**\n\n"
        "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard,
        parse_mode='Markdown'
    )


@rate_limit("general")
@track_errors_async("friend_requests_command")
async def friend_requests_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show friend requests management."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    # Get dependencies
    db_client: DatabaseClient = context.bot_data['db_client']
    
    from bot.database.friend_operations import FriendOperations
    friend_ops = FriendOperations(db_client)
    
    # Get friend requests
    requests_data = await friend_ops.get_friend_requests_optimized(user.id)
    
    incoming = requests_data.get('incoming', [])
    outgoing = requests_data.get('outgoing', [])
    
    text = "üì• **–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è**\n\n"
    
    if incoming:
        text += "**–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:**\n"
        for req in incoming[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5
            username = req.get('tg_username', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            name = req.get('tg_first_name', '')
            text += f"‚Ä¢ @{username} ({name})\n"
            text += f"  `/accept @{username}` | `/decline @{username}`\n\n"
    else:
        text += "**–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:** –Ω–µ—Ç\n\n"
    
    if outgoing:
        text += "**–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:**\n"
        for req in outgoing[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5
            username = req.get('tg_username', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            name = req.get('tg_first_name', '')
            text += f"‚Ä¢ @{username} ({name}) - –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞\n"
    else:
        text += "**–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:** –Ω–µ—Ç"
    
    await update.message.reply_text(text, parse_mode='Markdown')


@rate_limit("friend_request")
@track_errors_async("accept_friend_command")  
async def accept_friend_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Accept friend request."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    if not context.args:
        await update.message.reply_text(
            "üë• **–ü—Ä–∏–Ω—è—Ç—å –≤ –¥—Ä—É–∑—å—è**\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `/accept @username`",
            parse_mode='Markdown'
        )
        return
    
    target_username = context.args[0].lstrip('@')
    
    # Get dependencies
    db_client: DatabaseClient = context.bot_data['db_client']
    user_cache: TTLCache = context.bot_data['user_cache']
    
    from bot.database.friend_operations import FriendOperations
    from bot.database.user_operations import UserOperations
    
    friend_ops = FriendOperations(db_client)
    user_ops = UserOperations(db_client, user_cache)
    
    # Find requester by username
    requester = await user_ops.find_user_by_username(target_username)
    if not requester:
        await update.message.reply_text(
            f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{target_username} –Ω–µ –Ω–∞–π–¥–µ–Ω."
        )
        return
    
    # Accept friend request
    success = await friend_ops.accept_friend_request(requester['tg_id'], user.id)
    if success:
        await update.message.reply_text(
            f"‚úÖ –ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç @{target_username} –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã –¥—Ä—É–∑—å—è! üéâ"
        )
        
        # Notify requester if possible
        try:
            await context.bot.send_message(
                chat_id=requester['tg_id'],
                text=f"üéâ @{user.username or user.first_name} –ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –≤ –¥—Ä—É–∑—å—è!"
            )
        except Exception as e:
            logger.warning(f"Could not notify user {requester['tg_id']}: {e}")
    else:
        await update.message.reply_text(
            f"‚ùå –ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è –æ—Ç @{target_username} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –æ–Ω–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞."
        )


@rate_limit("friend_request")
@track_errors_async("decline_friend_command")
async def decline_friend_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Decline friend request."""
    user = update.effective_user
    if user is None:
        return

    set_user_context(user.id, user.username, user.first_name)
    
    if not context.args:
        await update.message.reply_text(
            "üë• **–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É**\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `/decline @username`",
            parse_mode='Markdown'
        )
        return
    
    target_username = context.args[0].lstrip('@')
    
    # Get dependencies
    db_client: DatabaseClient = context.bot_data['db_client']
    user_cache: TTLCache = context.bot_data['user_cache']
    
    from bot.database.friend_operations import FriendOperations
    from bot.database.user_operations import UserOperations
    
    friend_ops = FriendOperations(db_client)
    user_ops = UserOperations(db_client, user_cache)
    
    # Find requester by username
    requester = await user_ops.find_user_by_username(target_username)
    if not requester:
        await update.message.reply_text(
            f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{target_username} –Ω–µ –Ω–∞–π–¥–µ–Ω."
        )
        return
    
    # Decline friend request
    success = await friend_ops.decline_friend_request(requester['tg_id'], user.id)
    if success:
        await update.message.reply_text(
            f"‚ùå –ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç @{target_username} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞."
        )
        
        # Notify requester if possible
        try:
            await context.bot.send_message(
                chat_id=requester['tg_id'],
                text=f"‚ùå @{user.username or user.first_name} –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –≤ –¥—Ä—É–∑—å—è."
            )
        except Exception as e:
            logger.warning(f"Could not notify user {requester['tg_id']}: {e}")
    else:
        await update.message.reply_text(
            f"‚ùå –ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è –æ—Ç @{target_username} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –æ–Ω–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞."
        )


def setup_command_handlers(
    application: Application,
    db_client: DatabaseClient,
    user_cache: TTLCache,
    rate_limiter: MultiTierRateLimiter,
    config: Config
) -> None:
    """Setup all command handlers."""
    
    # Store dependencies in bot_data for access in handlers
    application.bot_data.update({
        'db_client': db_client,
        'user_cache': user_cache,
        'rate_limiter': rate_limiter,
        'config': config
    })
    
    # Register command handlers
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("settings", settings_command))
    application.add_handler(CommandHandler("history", history_command))
    application.add_handler(CommandHandler("add_friend", add_friend_command))
    application.add_handler(CommandHandler("friends", friends_command))
    application.add_handler(CommandHandler("friend_requests", friend_requests_command))
    application.add_handler(CommandHandler("accept", accept_friend_command))
    application.add_handler(CommandHandler("decline", decline_friend_command))
    
    logger.info("Command handlers registered successfully")